---
// Search Modal component
---

<div id="search-modal" class="search-modal" aria-hidden="true">
  <div class="search-overlay" data-close-search></div>
  <div class="search-container">
    <div class="search-input-wrapper">
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input
        type="text"
        id="search-input"
        class="search-input"
        placeholder="Cerca articoli..."
        autocomplete="off"
      />
      <kbd class="search-kbd">ESC</kbd>
    </div>
    <div id="search-results" class="search-results">
      <div class="search-empty">Inizia a digitare per cercare...</div>
    </div>
  </div>
</div>

<style>
  .search-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 15vh;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }

  .search-modal.open {
    opacity: 1;
    visibility: visible;
  }

  .search-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .search-container {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin: 0 var(--space-lg);
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    transform: translateY(-20px);
    transition: transform 0.2s ease;
  }

  .search-modal.open .search-container {
    transform: translateY(0);
  }

  .search-input-wrapper {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-subtle);
  }

  .search-icon {
    flex-shrink: 0;
    color: var(--text-muted);
  }

  .search-input {
    flex: 1;
    background: none;
    border: none;
    font-size: 1.1rem;
    font-family: var(--font-sans);
    color: var(--text-primary);
    outline: none;
  }

  .search-input::placeholder {
    color: var(--text-muted);
  }

  .search-kbd {
    font-size: 0.75rem;
    font-family: var(--font-mono);
    color: var(--text-muted);
    background: var(--bg-primary);
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid var(--border-subtle);
  }

  .search-results {
    max-height: 400px;
    overflow-y: auto;
  }

  .search-results :global(.search-empty),
  .search-results :global(.search-no-results) {
    padding: 32px 24px;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.9rem;
    font-style: italic;
  }

  .search-results :global(.search-result-item) {
    display: flex;
    align-items: center;
    padding: 16px 24px;
    text-decoration: none;
    transition: background 0.15s ease;
  }

  .search-results :global(.search-result-item:hover) {
    background: rgba(255, 255, 255, 0.05);
  }

  .search-results :global(.search-result-item.active) {
    background: rgba(255, 255, 255, 0.1);
  }

  .search-results :global(.search-result-title) {
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .search-results :global(.search-result-item.active .search-result-title) {
    color: white;
  }

  @media (max-width: 600px) {
    .search-modal {
      padding-top: 10vh;
    }

    .search-container {
      margin: 0 var(--space-md);
      border-radius: 12px;
    }

    .search-kbd {
      display: none;
    }
  }
</style>

<script>
  interface Post {
    title: string;
    slug: string;
    tags: string[];
  }

  let posts: Post[] = [];
  let activeIndex = 0;

  const modal = document.getElementById('search-modal');
  const input = document.getElementById('search-input') as HTMLInputElement;
  const results = document.getElementById('search-results');
  const overlay = document.querySelector('[data-close-search]');

  // Load posts data
  async function loadPosts() {
    if (posts.length > 0) return;
    try {
      const res = await fetch('/api/posts.json');
      posts = await res.json();
    } catch (e) {
      console.error('Failed to load posts:', e);
    }
  }

  function openSearch() {
    modal?.classList.add('open');
    document.body.style.overflow = 'hidden';
    input?.focus();
    loadPosts();
  }

  function closeSearch() {
    modal?.classList.remove('open');
    document.body.style.overflow = '';
    if (input) input.value = '';
    renderResults([]);
    activeIndex = 0;
  }

  function renderResults(filtered: Post[]) {
    if (!results) return;

    if (filtered.length === 0 && input?.value) {
      results.innerHTML = '<div class="search-no-results">Nessun risultato trovato</div>';
      return;
    }

    if (filtered.length === 0) {
      results.innerHTML = '<div class="search-empty">Inizia a digitare per cercare...</div>';
      return;
    }

    results.innerHTML = filtered.map((post, i) => `
      <a href="/blog/${post.slug}" class="search-result-item ${i === activeIndex ? 'active' : ''}" data-index="${i}">
        <div class="search-result-title">${highlightMatch(post.title, input?.value || '')}</div>
      </a>
    `).join('');
  }

  function highlightMatch(text: string, query: string): string {
    if (!query) return text;
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<mark style="background: var(--gold); color: var(--bg-primary); border-radius: 2px; padding: 0 2px;">$1</mark>');
  }

  function filterPosts(query: string): Post[] {
    if (!query) return [];
    const q = query.toLowerCase();
    return posts.filter(post =>
      post.title.toLowerCase().includes(q) ||
      post.tags.some(tag => tag.toLowerCase().includes(q))
    );
  }

  function updateActiveIndex(newIndex: number, filtered: Post[]) {
    if (filtered.length === 0) return;
    activeIndex = Math.max(0, Math.min(newIndex, filtered.length - 1));
    renderResults(filtered);
  }

  // Event listeners
  input?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value;
    activeIndex = 0;
    const filtered = filterPosts(query);
    renderResults(filtered);
  });

  input?.addEventListener('keydown', (e) => {
    const filtered = filterPosts(input.value);

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      updateActiveIndex(activeIndex + 1, filtered);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      updateActiveIndex(activeIndex - 1, filtered);
    } else if (e.key === 'Enter' && filtered.length > 0) {
      e.preventDefault();
      window.location.href = `/blog/${filtered[activeIndex].slug}`;
    } else if (e.key === 'Escape') {
      closeSearch();
    }
  });

  overlay?.addEventListener('click', closeSearch);

  // Global keyboard shortcut (Cmd/Ctrl + K)
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      if (modal?.classList.contains('open')) {
        closeSearch();
      } else {
        openSearch();
      }
    }
    if (e.key === 'Escape' && modal?.classList.contains('open')) {
      closeSearch();
    }
  });

  // Expose open function globally for the header button
  (window as any).openSearch = openSearch;
</script>
